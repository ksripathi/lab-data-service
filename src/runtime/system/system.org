#+TITLE: System implementation for LDS
#+AUTHOR: VLEAD
#+DATE: [2016-12-20 Thu]
#+SETUPFILE: ../../org-templates/level-2.org
#+TAGS: boilerplate(b)
#+EXCLUDE_TAGS: boilerplate
#+OPTIONS: ^:nil


* Introduction
A system has clear boundaries of input, output and state.
In the context of our application, the system interacts with
the external world (through command line function calls)
and also manages the entity objects in such a way that the
system invariants are maintained. 

The system's inputs are in terms of /operations/.  Each
operation consists of an operation name and a sequence of
arguments.  

In this implementation, an operation is identified by a
class.  The dictionary =ops_table= maps operation names to
their corresponding classes.

Each operation is divided into four checks.  A /check/ is a
predicate that either returns true or throws an exception.

The following checks are performed:

  - Arity check :: checks if the operation has the right
       number  of arguments.

  - Type check :: checks if the arguments have the correct
       type. 

  - Auth check :: checks if the session performing the
       operation is authorized to do so.

  - State check :: checks if the operation meets all the
       constraints imposed by the state of the system
       (referential integrity constraints, etc.)
 

** Structure of each operation class

The class corresponding to each operation has five fields:

  - arg_types :: a list of type predicates.  The length of
       this list is the arity of the operation.  The arity
       check is simply a comparison of the length of this
       list with the length of the list of arguments.  Each
       predicate in the =arg_types= list is applied to the
       corresponding argument to check the type of that
       argument.

  - auth_check :: a function that checks if the  =args= (which
       may include a session) together satisfy the
       authorization conditions imposed by the operation. 

  - state_check :: a function that checks =args= and checks
       if the particular state invariant holds.

  - action :: a function on args that (presumably) changes
       the state of the system and also returns an answer.
       An exception thrown by this function indicates a
       serious failure in the application (e.g., out of
       memory error). 
       

* The =System= class
  There is only one =System= in the application.

** Constructor
   This is the generic =System= implementation.  The entities that make up the
   sytem can be pure objects or objects that can be persisted.

   The specific tasks on the composed objects is agnostic to the =system=.
   This is achieved by defining an API that the system uses and is implemented
   by composed entity set.

   The system is initialized based on what the system should be composed of.

#+NAME: class_system
#+begin_src python
class System ():

    def __init__(self):
        raise Error('Can not instantiate')

    @staticmethod
    def initialize_system(cls):
        System.delegate = cls()

    @staticmethod
    def is_session_valid(session):
        return session.get("key") == KEY
 
#+end_src

*** Test Constructor
#+NAME: test_constructor
#+BEGIN_SRC python
class TestSystemConstructor(TestCase):
    TESTING = True

    def create_app(self):
        app = create_app(config)
        return app

    def setUp(self):
        System.initialize_system(PersistenceDelegate)

    def tearDown(self):
        System.delegate = None

    def test_delegate(self):
        print "test_delegate"
        self.assertEqual(isinstance(System.delegate, PersistenceDelegate), 
                             True)

    def test_is_session_valid(self):
        print "test_is_session_valid"
        session = Session(key=KEY)
        self.assertEqual(System.is_session_valid(session), True)

    def test_is_session_not_valid(self):
        print "test_is_session_not_valid"
        session = Session(key="jdhfkjhdakjf")
        self.assertEqual(System.is_session_valid(session), False)

#+END_SRC


** Arity and Type check methods 
   Arity Check ensures that correct number of arguments are passed to a
   functions.  Type Check ensures that the type of the arguments passed to a
   function are same as expected.
   
   Any operation, before being executed is subjected to =Arity= and =Type=
   checks.

#+NAME: arity_type_checks
#+BEGIN_SRC python
   
    @staticmethod
    def arity_check(args, n):
       if  (len(args) != n) :
          raise ArityError("arity mismatch: size of args  does not " + 
                           "match operation arity " )

    @staticmethod
    def type_check(args, arg_types):
        for key, value in args.iteritems():
            if not arg_types[key](value):
                raise TypeError("type mismatch: argument %s is not of "
                                "type %s" % (value, key))

#+end_src

*** Test Arity and Type Checks
  #+NAME: test_arity_and_types
  #+BEGIN_SRC python
    def test_arity(self):
        print "test_arity"
        with self.assertRaises(ArityError):
            System.arity_check([1,2], 3)

    def test_type_checks(self):
        print "test_type_checks"
        args = {"lab": Session(key=KEY)}

        arg_types = {"lab": is_lab}

        with self.assertRaises(TypeError):
            System.type_check(args, arg_types)

  #+END_SRC
  
    
* =do= method 
   The =do= method is the main work-horse of =System= which is constructed as the
   =Controller=.  Every operation follows a template and realized as a class
   that defines:
   1. Number of Arguments
   2. Type of Arguments
   3. Who is allowed to perform the operation
   4. Referential integrity checks and finally
   5. the operation that changes state of the system. 


#+NAME: do_function
#+begin_src python
    @staticmethod   
    def do(op, **args):
        cls = ops_table[op]
        arg_types  = cls.arg_types
        auth_check = cls.auth_check
        state_check = cls.state_check
        arity_and_type_checks_needed = cls.arity_and_type_checks_needed
        try:
            if arity_and_type_checks_needed:
               System.arity_check(args.keys(), len(arg_types.keys()))
               System.type_check(args, arg_types)
            auth_check(args)
            state_check(args)
            return cls.action(args)
        except (ArityError, TypeError, NotAuthorizedError, StateError) as err:
            raise err

#+end_src


* Operations
  Operations provide the mechanism to either change or retrieve the state of
  the system.  While the system state is changed, it is imperative to maintain
  the invariant of the system.  Before the actual change in system is made,
  each operation goes through a series of checks:
  1. Arity Check - ensures the right number of arguments are provided to
     the operation.
  2. Type Check - ensures the arguments are of right type
  3. Auth Check - ensures only the authorized can perform the operation
  4. State Check - ensures System invariant is maintained

  Once these checks are satisfied, either the system state is modified or retrieved.

** =AddLab=
#+NAME: class_add_lab
#+begin_src python
class AddLab():
    arg_types = {"lab": is_lab, "session": is_session}
    arity_and_type_checks_needed = True

    @staticmethod
    def auth_check(args):
        session = args['session']
        if not System.is_session_valid(session):
            raise NotAuthorizedError("Not Authorized to perform this action")

    @staticmethod
    def state_check(args):
        lab = args["lab"]
        if System.delegate.lab_exists(lab):
            raise StateError("lab %s already exists in System"
                                 % lab.to_client())

    @staticmethod
    def action(args):
        lab = args["lab"]
        lab = System.delegate.add_lab(lab)
        return lab

#+end_src



** =AddExperiment=
#+NAME: class_add_experiment
#+begin_src python
class AddExperiment():
    arg_types = {"experiment": is_experiment, "session": is_session}
    arity_and_type_checks_needed = True

    @staticmethod
    def auth_check(args):
        session = args['session']
        if not System.is_session_valid(session):
            raise NotAuthorizedError("Not Authorized to perform this action")

    @staticmethod
    def state_check(args):
        experiment = args["experiment"]
        if System.delegate.experiment_exists(experiment):
            raise StateError("experiment %s already exists in System"
                                 % experiment.to_client())

    @staticmethod
    def action(args):
        experiment = args["experiment"]
        experiment = System.delegate.add_experiment(experiment)
        return experiment

#+end_src



** =AddSection=
#+NAME: class_add_section
#+begin_src python
class AddSection():
    arg_types = {"section": is_section, "session": is_session}
    arity_and_type_checks_needed = True

    @staticmethod
    def auth_check(args):
        session = args['session']
        if not System.is_session_valid(session):
            raise NotAuthorizedError("Not Authorized to perform this action")

    @staticmethod
    def state_check(args):
        section = args["section"]
        if System.delegate.section_exists(section):
            raise StateError("section %s already exists in System"
                                 % section.to_client())

    @staticmethod
    def action(args):
        section = args["section"]
        section = System.delegate.add_section(section)
        return section

#+end_src



** =AddInstitute=
#+NAME: class_add_institute
#+begin_src python
class AddInstitute():
    arg_types = {"institute": is_institute, "session": is_session}
    arity_and_type_checks_needed = True

    @staticmethod
    def auth_check(args):
        session = args['session']
        if not System.is_session_valid(session):
            raise NotAuthorizedError("Not Authorized to perform this action")

    @staticmethod
    def state_check(args):
        institute = args["institute"]
        if System.delegate.institute_exists(institute):
            raise StateError("institute %s already exists in System"
                                 % institute.to_client())

    @staticmethod
    def action(args):
        institute = args["institute"]
        institute = System.delegate.add_institute(institute)
        return institute

#+end_src



** =AddDiscipline=
#+NAME: class_add_discipline
#+begin_src python
class AddDiscipline():
    arg_types = {"discipline": is_discipline, "session": is_session}
    arity_and_type_checks_needed = True

    @staticmethod
    def auth_check(args):
        session = args['session']
        if not System.is_session_valid(session):
            raise NotAuthorizedError("Not Authorized to perform this action")

    @staticmethod
    def state_check(args):
        discipline = args["discipline"]
        if System.delegate.discipline_exists(discipline):
            raise StateError("discipline %s already exists in System"
                                 % discipline.to_client())

    @staticmethod
    def action(args):
        discipline = args["discipline"]
        discipline = System.delegate.add_discipline(discipline)
        return discipline

#+end_src



** =AddHostingInfo=
#+NAME: class_add_hostinginfo
#+begin_src python
class AddHostingInfo():
    arg_types = {"hostinginfo": is_hostinginfo, "session": is_session}
    arity_and_type_checks_needed = True

    @staticmethod
    def auth_check(args):
        session = args['session']
        if not System.is_session_valid(session):
            raise NotAuthorizedError("Not Authorized to perform this action")

    @staticmethod
    def state_check(args):
        hostinginfo = args["hostinginfo"]
        if System.delegate.hostinginfo_exists(hostinginfo):
            raise StateError("hostinginfo %s already exists in System"
                                 % hostinginfo.to_client())

    @staticmethod
    def action(args):
        hostinginfo = args["hostinginfo"]
        hostinginfo = System.delegate.add_hostinginfo(hostinginfo)
        return hostinginfo

#+end_src



** =AddName=
#+NAME: class_add_name
#+begin_src python
class AddName():
    arg_types = {"name": is_name, "session": is_session}
    arity_and_type_checks_needed = True

    @staticmethod
    def auth_check(args):
        session = args['session']
        if not System.is_session_valid(session):
            raise NotAuthorizedError("Not Authorized to perform this action")

    @staticmethod
    def state_check(args):
        name = args["name"]
        if System.delegate.name_exists(name):
            raise StateError("name %s already exists in System"
                                 % name.to_client())

    @staticmethod
    def action(args):
        name = args["name"]
        name = System.delegate.add_name(name)
        return name

#+end_src



** =AddEmail=
#+NAME: class_add_email
#+begin_src python
class AddEmail():
    arg_types = {"email": is_email, "session": is_session}
    arity_and_type_checks_needed = True

    @staticmethod
    def auth_check(args):
        session = args['session']
        if not System.is_session_valid(session):
            raise NotAuthorizedError("Not Authorized to perform this action")

    @staticmethod
    def state_check(args):
        email = args["email"]
        if System.delegate.email_exists(email):
            raise StateError("email %s already exists in System"
                                 % email.to_client())

    @staticmethod
    def action(args):
        email = args["email"]
        email = System.delegate.add_email(email)
        return email

#+end_src



** =AddDeveloper=
#+NAME: class_add_developer
#+begin_src python
class AddDeveloper():
    arg_types = {"developer": is_developer, "session": is_session}
    arity_and_type_checks_needed = True

    @staticmethod
    def auth_check(args):
        session = args['session']
        if not System.is_session_valid(session):
            raise NotAuthorizedError("Not Authorized to perform this action")

    @staticmethod
    def state_check(args):
        developer = args["developer"]
        if System.delegate.developer_exists(developer):
            raise StateError("developer %s already exists in System"
                                 % developer.to_client())

    @staticmethod
    def action(args):
        developer = args["developer"]
        developer = System.delegate.add_developer(developer)
        return developer

#+end_src


** =AddIntegrationStatus=
#+NAME: class_add_integrationstatus
#+begin_src python
class AddIntegrationStatus():
    arg_types = {"integrationstatus": is_integrationstatus, "session": is_session}
    arity_and_type_checks_needed = True

    @staticmethod
    def auth_check(args):
        session = args['session']
        if not System.is_session_valid(session):
            raise NotAuthorizedError("Not Authorized to perform this action")

    @staticmethod
    def state_check(args):
        integrationstatus = args["integrationstatus"]
        if System.delegate.integrationstatus_exists(integrationstatus):
            raise StateError("integrationstatus %s already exists in System"
                                 % integrationstatus.to_client())

    @staticmethod
    def action(args):
        integrationstatus = args["integrationstatus"]
        integrationstatus = System.delegate.add_integrationstatus(integrationstatus)
        return integrationstatus

#+end_src




** =UpdateLab=
#+NAME: class_update_lab
#+begin_src python
class UpdateLab():
    arg_types = {"lab": is_lab, "lab_name": is_str,
                     "overview" : is_str, "session": is_session}
    arity_and_type_checks_needed = True

    @staticmethod
    def auth_check(args):
        session = args['session']
        if not System.is_session_valid(session):
            raise NotAuthorizedError("Not Authorized to perform this action")

    @staticmethod
    def state_check(args):
        lab = args["lab"]
        if not System.delegate.lab_exists(lab):
            raise StateError("lab %s does not exists in System"
                                 % lab.to_client())

    @staticmethod
    def action(args):
        lab = args["lab"]
        lab_name = args["lab_name"]
        overview = args["overview"]
        lab = System.delegate.update_lab(lab, lab_name, overview)
        return lab

#+end_src



** =UpdateExperiment=
#+NAME: class_update_experiment
#+begin_src python
class UpdateExperiment():
    arg_types = {"exp_name": is_str_or_none,
                     "experiment": is_experiment,
                     "overview" : is_str,
                     "session": is_session}
    arity_and_type_checks_needed = True

    @staticmethod
    def auth_check(args):
        session = args['session']
        if not System.is_session_valid(session):
            raise NotAuthorizedError("Not Authorized to perform this action")

    @staticmethod
    def state_check(args):
        experiment = args['experiment']
        if not System.delegate.experiment_exists(experiment):
            raise StateError("experiment %s does not exists in System"
                                 % experiment.to_client())
        
    @staticmethod
    def action(args):
        experiment = args["experiment"]
        exp_name=args["exp_name"]
        overview = args["overview"]
        exp = System.delegate.update_experiment(experiment, exp_name, overview)
        return exp

#+end_src



** =UpdateSection=
#+NAME: class_update_section
#+begin_src python
class UpdateSection():
    arg_types = {"section": is_section, "name": is_str_or_none,
                     "session": is_session}
    arity_and_type_checks_needed = True

    @staticmethod
    def auth_check(args):
        session = args['session']
        if not System.is_session_valid(session):
            raise NotAuthorizedError("Not Authorized to perform this action")

    @staticmethod
    def state_check(args):
        section = args['section']
        if not System.delegate.section_exists(section):
            raise StateError("section %s does not exists in System"
                                 % section.to_client())
        
    @staticmethod
    def action(args):
        section = args["section"]
        if not "name" in args:
           name=section.get("name")
        else:
           name=args["name"]

        section = System.delegate.update_section(section, name)
        return section

#+end_src



** =UpdateDiscipline=
#+NAME: class_update_Discipline
#+begin_src python
class UpdateDiscipline():
    arg_types = {"discipline": is_discipline, "dis_name": is_str_or_none,
                     "session": is_session}
    arity_and_type_checks_needed = True

    @staticmethod
    def auth_check(args):
        session = args['session']
        if not System.is_session_valid(session):
            raise NotAuthorizedError("Not Authorized to perform this action")

    @staticmethod
    def state_check(args):
        discipline = args['discipline']
        if not System.delegate.discipline_exists(discipline):
            raise StateError("discipline %s does not exists in System"
                                 % discipline.to_client())
        
    @staticmethod
    def action(args):
        discipline = args["discipline"]
        dis_name=args["dis_name"]
        dis = System.delegate.update_discipline(discipline, dis_name)
        return dis

#+end_src



** =UpdateInstitute=
#+NAME: class_update_institute
#+begin_src python
class UpdateInstitute():
    arg_types = {"institute": is_institute, "inst_name": is_str_or_none, 
                       "session": is_session}                               
    arity_and_type_checks_needed = True

    @staticmethod
    def auth_check(args):
        session = args['session']
        if not System.is_session_valid(session):
            raise NotAuthorizedError("Not Authorized to perform this action")

    @staticmethod
    def state_check(args):
        institute = args['institute']
        if not System.delegate.institute_exists(institute):
            raise StateError("institute %s does not exists in System"
                                 % institute.to_client())


    @staticmethod
    def action(args):
        inst_name = args["inst_name"]
        institute = args["institute"]       
        institute = System.delegate.update_institute(institute, inst_name)
        return institute

#+end_src



** =UpdateName=
#+NAME: class_update_name
#+begin_src python
class UpdateName():
    arg_types = {"name": is_name, "session": is_session}
    arity_and_type_checks_needed = True

    @staticmethod
    def auth_check(args):
        session = args['session']
        if not System.is_session_valid(session):
            raise NotAuthorizedError("Not Authorized to perform this action")

    @staticmethod
    def state_check(args):
        name = args['name']
        if not System.delegate.name_exists(name):
            raise StateError("name %s does not exists in System"
                                 % name.to_client())

    @staticmethod
    def action(args):
        name = args["name"]
        if not "name" in args:
           name=name.get("name")
        else:
           name=args["name"]

        section = System.delegate.update_name(name, name)
        return name

#+end_src



** =UpdateEmail=
#+NAME: class_update_email
#+begin_src python
class UpdateEmail():
    arg_types = {"email": is_email, "session": is_session}
    arity_and_type_checks_needed = True

    @staticmethod
    def auth_check(args):
        session = args['session']
        if not System.is_session_valid(session):
            raise NotAuthorizedError("Not Authorized to perform this action")

    @staticmethod
    def state_check(args):
        email = args['email']
        if not System.delegate.email_exists(email):
            raise StateError("email %s does not exists in System"
                                 % email.to_client())

    @staticmethod
    def action(args):
        email = args["email"]
        if not "email" in args:
           email=email.get("email")
        else:
           email=args["email"]

        email = System.delegate.update_email(email, email)
        return email

#+end_src



** =UpdateDeveloper=
#+NAME: class_update_developer
#+begin_src python
class UpdateDeveloper():
    arg_types = {"developer": is_developer, "name": is_name,
                     "session": is_session}
    arity_and_type_checks_needed = True

    @staticmethod
    def auth_check(args):
        session = args['session']
        if not System.is_session_valid(session):
            raise NotAuthorizedError("Not Authorized to perform this action")

    @staticmethod
    def state_check(args):
        developer = args["developer"]
        if not System.delegate.developer_exists(developer):
            raise StateError("developer %s does not exists in System"
                                 % developer.to_client())

    @staticmethod
    def action(args):
        developer = args["developer"]
        if not "name" in args:
           name=developer.get("name")
        else:
           name=args["name"]

        section = System.delegate.update_developer(developer, name)
        return developer

#+end_src


** =UpdateHostingInfo=
#+NAME: class_update_hostinginfo
#+begin_src python
class UpdateHostingInfo():
    arg_types = {"hostinginfo": is_hostinginfo, "hosting_status": is_str_or_none, "hosted_on": is_str_or_none, "session": is_session}                               
    arity_and_type_checks_needed = True

    @staticmethod
    def auth_check(args):
        session = args['session']
        if not System.is_session_valid(session):
            raise NotAuthorizedError("Not Authorized to perform this action")

    @staticmethod
    def state_check(args):
        pass


    @staticmethod
    def action(args):
        hosting_status = args["hosting_status"]
        hosted_on = args["hosted_on"]
        hostinginfo = args["hostinginfo"]       
        hostinginfo = System.delegate.update_hostinginfo(hostinginfo, hosting_status, hosted_on)
        return hostinginfo

#+end_src



** =DeleteLab=
#+NAME: class_delete_lab
#+begin_src python
class DeleteLab():
    arg_types = {"lab_id": is_str, "session": is_session}
    arity_and_type_checks_needed = True

    @staticmethod
    def auth_check(args):
        session = args['session']
        if not System.is_session_valid(session):
            raise NotAuthorizedError("Not Authorized to perform this action")

    @staticmethod
    def state_check(args):
        lab_id = args['lab_id']
        lab = System.delegate.get_lab(lab_id=lab_id)
        if not System.delegate.lab_exists(lab):
            raise StateError("lab %s does not exists in System"
                                 % lab.to_client())

    @staticmethod
    def action(args):
        lab_id = args["lab_id"]
        lab_id = System.delegate.delete_lab(lab_id)
        return lab_id

#+end_src



** =DeleteExperiment=
#+NAME: class_delete_experiment
#+begin_src python
class DeleteExperiment():
    arg_types = {"exp_id": is_str, "session": is_session}
    arity_and_type_checks_needed = True

    @staticmethod
    def auth_check(args):
        session = args['session']
        if not System.is_session_valid(session):
            raise NotAuthorizedError("Not Authorized to perform this action")

    @staticmethod
    def state_check(args):
        exp_id = args['exp_id']
        experiment = System.delegate.get_experiment(exp_id=exp_id)
        if not System.delegate.experiment_exists(experiment):
            raise StateError("experiment %s does not exists in System"
                                 % experiment.to_client())

    @staticmethod
    def action(args):
        exp_id = args["exp_id"]
        exp_id = System.delegate.delete_experiment(exp_id)
        return exp_id
        
#+end_src


** =DeleteDiscipline=
#+NAME: class_delete_discipline
#+begin_src python
class DeleteDiscipline():
    arg_types = {"dis_id": is_str, "session": is_session}
    arity_and_type_checks_needed = True

    @staticmethod
    def auth_check(args):
        session = args['session']
        if not System.is_session_valid(session):
            raise NotAuthorizedError("Not Authorized to perform this action")

    @staticmethod
    def state_check(args):
        dis_id = args['dis_id']
        discipline = System.delegate.get_discipline(dis_id=dis_id)    
        if not System.delegate.discipline_exists(discipline):
            raise StateError("discipline %s does not exists in System"
                                 % discipline.to_client())

    @staticmethod
    def action(args):
        dis_id = args["dis_id"]
        dis_id = System.delegate.delete_discipline(dis_id)
        return dis_id

#+end_src




** =DeleteInstitute=
#+NAME: class_delete_institute
#+begin_src python
class DeleteInstitute():
    arg_types = {"inst_id": is_str, "session": is_session}
    arity_and_type_checks_needed = True

    @staticmethod
    def auth_check(args):
        session = args['session']
        if not System.is_session_valid(session):
            raise NotAuthorizedError("Not Authorized to perform this action")

    @staticmethod
    def state_check(args):
        inst_id = args['inst_id']
        institute = System.delegate.get_institute(inst_id=inst_id)    
        if not System.delegate.institute_exists(institute):
            raise StateError("institute %s does not exists in System"
                                 % institute.to_client())

    @staticmethod
    def action(args):
        inst_id = args["inst_id"]
        inst_id = System.delegate.delete_institute(inst_id)
        return inst_id
        
#+end_src




** =DeleteSection=
#+NAME: class_delete_section
#+begin_src python
class DeleteSection():
    arg_types = {"s_id": is_int, "session": is_session}
    arity_and_type_checks_needed = True

    @staticmethod
    def auth_check(args):
        session = args['session']
        if not System.is_session_valid(session):
            raise NotAuthorizedError("Not Authorized to perform this action")

    @staticmethod
    def state_check(args):
        pass

    @staticmethod
    def action(args):
        s_id = args["s_id"]
        s_id = System.delegate.delete_section(s_id)
        return s_id
        
#+end_src



** =DeleteName=
#+NAME: class_delete_name
#+begin_src python
class DeleteName():
    arg_types = {"name": is_name, "session": is_session}
    arity_and_type_checks_needed = True

    @staticmethod
    def auth_check(args):
        session = args['session']
        if not System.is_session_valid(session):
            raise NotAuthorizedError("Not Authorized to perform this action")

    @staticmethod
    def state_check(args):
        name = args['name']
        if not System.delegate.name_exists(name):
            raise StateError("name %s does not exists in System"
                                 % name.to_client())

    @staticmethod
    def action(args):
        name = args["name"]
        name1 = System.delegate.delete_name(name)
        return name1
        
#+end_src



** =DeleteEmail=
#+NAME: class_delete_email
#+begin_src python
class DeleteEmail():
    arg_types = {"email": is_email, "session": is_session}
    arity_and_type_checks_needed = True

    @staticmethod
    def auth_check(args):
        session = args['session']
        if not System.is_session_valid(session):
            raise NotAuthorizedError("Not Authorized to perform this action")

    @staticmethod
    def state_check(args):
        email = args['email']
        if not System.delegate.email_exists(email):
            raise StateError("email %s does not exists in System"
                                 % email.to_client())

    @staticmethod
    def action(args):
        email = args["email"]
        email = System.delegate.delete_email(email)
        return email
        
#+end_src



** =DeleteDeveloper=
#+NAME: class_delete_developer
#+begin_src python
class DeleteDeveloper():
    arg_types = {"email": is_email, "session": is_session}
    arity_and_type_checks_needed = True

    @staticmethod
    def auth_check(args):
        session = args['session']
        if not System.is_session_valid(session):
            raise NotAuthorizedError("Not Authorized to perform this action")

    @staticmethod
    def state_check(args):
        pass

    @staticmethod
    def action(args):
        email = args["email"]
        email = System.delegate.delete_developer(email)
        return email
        
#+end_src



** =DeleteHostingInfo=
#+NAME: class_delete_hostinginfo
#+begin_src python
class DeleteHostingInfo():
    arg_types = {"hosted_url": is_url, "session": is_session}
    arity_and_type_checks_needed = True

    @staticmethod
    def auth_check(args):
        session = args['session']
        if not System.is_session_valid(session):
            raise NotAuthorizedError("Not Authorized to perform this action")

    @staticmethod
    def state_check(args):
        hosted_url = args['hosted_url']
        hostinginfo = System.delegate.get_hostinginfo(hosted_url=hosted_url)
        if not System.delegate.hostinginfo_exists(hostinginfo):
            raise StateError("hostinginfo %s does not exists in System"
                                 % hostinginfo.to_client())

    @staticmethod
    def action(args):
        hosted_url = args["hosted_url"]
        hosted_url = System.delegate.delete_hostinginfo(hosted_url)
        return hosted_url
        
#+end_src



** =DeleteIntegrationStatus=
#+NAME: class_delete_integrationstatus
#+begin_src python
class DeleteIntegrationStatus():
    arg_types = {"integration_level": is_int, "session": is_session}
    arity_and_type_checks_needed = True

    @staticmethod
    def auth_check(args):
        session = args['session']
        if not System.is_session_valid(session):
            raise NotAuthorizedError("Not Authorized to perform this action")

    @staticmethod
    def state_check(args):
        integration_level = args['integration_level']
        integrationstatus = System.delegate.get_integrationstatus(integration_level=integration_level)    
        if not System.delegate.integrationstatus_exists(integrationstatus):
            raise StateError("integrationstatus %s does not exists in System"
                                 % integrationstatus.to_client())

    @staticmethod
    def action(args):
        integration_level = args["integration_level"]
        integration_level = System.delegate.delete_integrationstatus(integration_level)
        return integration_level
        
#+end_src




** =GetLab=
#+NAME: class_get_lab
#+begin_src python
class GetLab():
    arg_types = {"lab_id": is_str}
    arity_and_type_checks_needed = True

    @staticmethod
    def auth_check(args):
        pass

    @staticmethod
    def state_check(args):
        lab_id = args['lab_id']
        lab = System.delegate.get_lab(lab_id=lab_id)
        if not System.delegate.lab_exists(lab):
            raise StateError("lab %s does not exists in System"
                                 % lab.to_client())

    @staticmethod
    def action(args):
        lab_id = args["lab_id"]
        lab = System.delegate.get_lab(lab_id=lab_id)
        return lab

#+end_src



** =GetExperiment=
#+NAME: class_get_experiment
#+begin_src python
class GetExperiment():
    arg_types = {"exp_id": is_str}
    arity_and_type_checks_needed = True

    @staticmethod
    def auth_check(args):
        pass
    @staticmethod
    def state_check(args):
        exp_id = args['exp_id']
        exp = System.delegate.get_experiment(exp_id=exp_id)
        if not System.delegate.experiment_exists(exp):
            raise StateError("experiment %s does not exists in System"
                                 % experiment.to_client())

    @staticmethod
    def action(args):
        exp_id = args["exp_id"]
        exp = System.delegate.get_experiment(exp_id=exp_id)
        return exp

#+end_src



** =GetInstitute=
#+NAME: class_get_institute
#+begin_src python
class GetInstitute():
    arg_types = {"inst_id": is_str}
    arity_and_type_checks_needed = True

    @staticmethod
    def auth_check(args):
        pass

    @staticmethod
    def state_check(args):
        inst_id = args['inst_id']
        institute = System.delegate.get_institute(inst_id=inst_id)    
        if not System.delegate.institute_exists(institute):
            raise StateError("institute %s does not exists in System"
                                 % institute.to_client())
        
    @staticmethod
    def action(args):
        inst_id = args["inst_id"]
        institute = System.delegate.get_institute(inst_id=inst_id)
        return institute

#+end_src




** =GetInstituteByInstituteName=
#+NAME: class_get_institute_by_institute_name
#+begin_src python
class GetInstituteByInstituteName():
    arg_types = {"inst_name": is_str}
    arity_and_type_checks_needed = True

    @staticmethod
    def auth_check(args):
        pass

    @staticmethod
    def state_check(args):
        pass

    @staticmethod
    def action(args):
        inst_name = args["inst_name"]
        institute = System.delegate.get_institute(inst_name=inst_name)
        return institute

#+end_src




** =GetDisciplineByDisciplineName=
#+NAME: class_get_discipline_by_discipline_name
#+begin_src python
class GetDisciplineByDisciplineName():
    arg_types = {"dis_name": is_str}
    arity_and_type_checks_needed = True

    @staticmethod
    def auth_check(args):
        pass

    @staticmethod
    def state_check(args):
        pass

    @staticmethod
    def action(args):
        dis_name = args["dis_name"]
        discipline = System.delegate.get_discipline(dis_name=dis_name)
        return discipline

#+end_src


** =GetDiscipline=
#+NAME: class_get_discipline
#+begin_src python
class GetDiscipline():
    arg_types = {"dis_id": is_str}
    arity_and_type_checks_needed = True

    @staticmethod
    def auth_check(args):
        pass

    @staticmethod
    def state_check(args):
        dis_id = args['dis_id']
        discipline = System.delegate.get_discipline(dis_id=dis_id)    
        if not System.delegate.discipline_exists(discipline):
            raise StateError("discipline %s does not exists in System"
                                 % discipline.to_client())
        
    @staticmethod
    def action(args):
        dis_id = args["dis_id"]
        discipline = System.delegate.get_discipline(dis_id=dis_id)
        return discipline

#+end_src




** =GetHostingInfo=
#+NAME: class_get_hostinginfo
#+begin_src python
class GetHostingInfo():
    arg_types = {"hosted_url": is_url}
    arity_and_type_checks_needed = True

    @staticmethod
    def auth_check(args):
        pass

    @staticmethod
    def state_check(args):
        hosted_url = args['hosted_url']
        hostinginfo = System.delegate.get_hostinginfo(hosted_url=hosted_url)
        if not System.delegate.hostinginfo_exists(hostinginfo):
            raise StateError("hostinginfo %s does not exists in System"
                                 % hostinginfo.to_client())
        
    @staticmethod
    def action(args):
        hosted_url = args["hosted_url"]
        hostinginfo = System.delegate.get_hostinginfo(hosted_url=hosted_url)
        return hostinginfo

#+end_src


** =GetLabsByInstitute=
#+NAME: class_get_labs_by_institute
#+begin_src python
class GetLabsByInstitute():
    arg_types = {"institute": is_institute}
    arity_and_type_checks_needed = True

    @staticmethod
    def auth_check(args):
        pass

    @staticmethod
    def state_check(args):
        pass

    @staticmethod
    def action(args):
        institute = args['institute']
        labs = System.delegate.get_labs(institute=institute)
        return labs

#+end_src


** =GetLabsByLabName=
#+NAME: class_get_labs_by_lab_name
#+begin_src python
class GetLabsByLabName():
    arg_types = {"lab_name": is_str}
    arity_and_type_checks_needed = True

    @staticmethod
    def auth_check(args):
        pass

    @staticmethod
    def state_check(args):
        pass

    @staticmethod
    def action(args):
        lab_name = args['lab_name']
        labs = System.delegate.get_labs(lab_name=lab_name)
        return labs

#+end_src


** =GetLabsByDiscipline=
#+NAME: class_get_labs_by_discipline
#+begin_src python
class GetLabsByDiscipline():
    arg_types = {"discipline": is_discipline}
    arity_and_type_checks_needed = True

    @staticmethod
    def auth_check(args):
        pass

    @staticmethod
    def state_check(args):
        pass

    @staticmethod
    def action(args):
        discipline = args['discipline']
        labs = System.delegate.get_labs(discipline=discipline)
        return labs

#+end_src


** =AddLabsToInstitute=
#+NAME: class_add_labs_to_institute
#+begin_src python
class AddLabsToInstitute():
    arg_types = {"labs": are_labs, "instituteid": is_int, 
                     "session": is_session}
    arity_and_type_checks_needed = True

    @staticmethod
    def auth_check(args):
        session = args['session']
        if not System.is_session_valid(session):
            current_app.logger.error("auth error raised, session = %s" % 
                                        session.to_client())
            raise NotAuthorizedError("Not Authorized to perform this action")

    @staticmethod
    def state_check(args):
        instituteid = args["instituteid"]
        if not System.delegate.institute_exists(instituteid):
            current_app.logger.error("institute with id = %d does not exist"
                                     "in System" % instituteid)
            raise StateError("institute with id = %d does not exist in System"
                                 % instituteid)

    @staticmethod
    def action(args):
        instituteid = args["instituteid"]
        labs = args["labs"]
        try:
            institute = System.delegate.add_labs_to_institute(instituteid, labs) 
            return institute
        except Exception as err:
            current_app.logger.error("Exception = %s" % str(err))
            raise err

#+end_src


** =AddSectionsToExperiment=
#+NAME: class_add_sections_to_experiment
#+begin_src python
class AddSectionsToExperiment():
    arg_types = {"sections": are_sections, "experiment": is_experiment, 
                     "session": is_session}
    arity_and_type_checks_needed = True

    @staticmethod
    def auth_check(args):
        session = args['session']
        if not System.is_session_valid(session):
            current_app.logger.error("auth error raised, session = %s" % 
                                        session.to_client())
            raise NotAuthorizedError("Not Authorized to perform this action")

    @staticmethod
    def state_check(args):
        experiment = args["experiment"]
        if not System.delegate.experiment_exists(experiment):
            current_app.logger.error("exp with id = %d does not exist"
                                     " in System" % experiment)
            raise StateError("lab with id = %d does not exist in System"
                                 % labid)

    @staticmethod
    def action(args):
        experiment = args["experiment"]
        sections = args["sections"]
        try:
            exp = System.delegate.add_sections_to_experiment(experiment, sections) 
            return exp
        except Exception as err:
            current_app.logger.error("Exception = %s" % str(err))
            raise err

#+end_src




** =GetName=
#+NAME: class_get_name
#+begin_src python
class GetName():
    arg_types = {"name": is_name, "session": is_session}

    arity_and_type_checks_needed = True

    @staticmethod
    def auth_check(args):
        session = args['session']
        current_app.logger.debug("checking authorization")
        if not System.is_session_valid(session):
            current_app.logger.debug("authorization is failed")
            raise NotAuthorizedError("Not Authorized to perform this action")
        current_app.logger.debug("authorization check is done")

    @staticmethod
    def state_check(args):
        pass

    @staticmethod
    def action(args):
        name = args["name"]
        name1 = System.delegate.get_name(name=name.get("name"))
        return name1

#+end_src



** =GetEmail=
#+NAME: class_get_email
#+begin_src python
class GetEmail():
    arg_types = {"email": is_email, "session": is_session}

    arity_and_type_checks_needed = True

    @staticmethod
    def auth_check(args):
        session = args['session']
        current_app.logger.debug("checking authorization")
        if not System.is_session_valid(session):
            current_app.logger.debug("authorization is failed")
            raise NotAuthorizedError("Not Authorized to perform this action")
        current_app.logger.debug("authorization check is done")

    @staticmethod
    def state_check(args):
        pass

    @staticmethod
    def action(args):
        email = args["email"]
        email1 = System.delegate.get_email(email=email.get("email"))
        return email1

#+end_src



** =GetDeveloper=
#+NAME: class_get_developer
#+begin_src python
class GetDeveloper():
    arg_types = {"email": is_email}

    arity_and_type_checks_needed = True

    @staticmethod
    def auth_check(args):
        pass

    @staticmethod
    def state_check(args):
        pass

    @staticmethod
    def action(args):
        email = args["email"]
        email = System.delegate.get_developer(email=email)
        return email

#+end_src



** =GetIntegrationStatus=
#+NAME: class_get_integrationstatus
#+begin_src python
class GetIntegrationStatus():
    arg_types = {"integration_level": is_int}
    arity_and_type_checks_needed = True

    @staticmethod
    def auth_check(args):
        pass

    @staticmethod
    def state_check(args):
        integration_level = args['integration_level']
        integrationstatus = System.delegate.get_integrationstatus(integration_level=integration_level)    
        if not System.delegate.integrationstatus_exists(integrationstatus):
            raise StateError("integrationstatus %s does not exists in System"
                                 % integrationstatus.to_client())
        
    @staticmethod
    def action(args):
        integration_level = args["integration_level"]
        integrationstatus = System.delegate.get_integrationstatus(integration_level=integration_level)
        return integrationstatus

#+end_src




** =AddAsset=
#+NAME: class_add_asset
#+begin_src python
class AddAsset():
    arg_types = {"asset": is_asset, "session": is_session}
    arity_and_type_checks_needed = True

    @staticmethod
    def auth_check(args):
        session = args['session']
        if not System.is_session_valid(session):
            raise NotAuthorizedError("Not Authorized to perform this action")

    @staticmethod
    def state_check(args):
        asset = args["asset"]
        if System.delegate.asset_exists(asset):
            raise StateError("asset %s already exists in System"
                                 % asset.to_client())

    @staticmethod
    def action(args):
        asset = args["asset"]
        asset = System.delegate.add_asset(asset)
        return asset

#+end_src



** =UpdateAsset=
#+NAME: class_update_asset
#+begin_src python
class UpdateAsset():
    arg_types = {"asset_type": is_str_or_none,
                     "asset": is_asset,
                     "session": is_session}
    arity_and_type_checks_needed = True

    @staticmethod
    def auth_check(args):
        session = args['session']
        if not System.is_session_valid(session):
            raise NotAuthorizedError("Not Authorized to perform this action")

    @staticmethod
    def state_check(args):
        asset = args['asset']
        if not System.delegate.asset_exists(asset):
            raise StateError("asset %s does not exists in System"
                                 % asset.to_client())
        
    @staticmethod
    def action(args):
        asset = args["asset"]
        asset_type=args["asset_type"]
        asst = System.delegate.update_asset(asset,asset_type)
        return asst

#+end_src


** =DeleteAsset=
#+NAME: class_delete_asset
#+begin_src python
class DeleteAsset():
    arg_types = {"path": is_str, "session": is_session}
    arity_and_type_checks_needed = True

    @staticmethod
    def auth_check(args):
        session = args['session']
        if not System.is_session_valid(session):
            raise NotAuthorizedError("Not Authorized to perform this action")

    @staticmethod
    def state_check(args):
        path = args['path']
        asset = System.delegate.get_asset(path=path)
        if not System.delegate.asset_exists(asset):
            raise StateError("asset %s does not exists in System"
                                 % asset.to_client())

    @staticmethod
    def action(args):
        path = args["path"]
        path = System.delegate.delete_asset(path)
        return path
        
#+end_src



** =GetAsset=
#+NAME: class_get_asset
#+begin_src python
class GetAsset():
    arg_types = {"path": is_str}
    arity_and_type_checks_needed = True

    @staticmethod
    def auth_check(args):
        pass
    @staticmethod
    def state_check(args):
        path = args['path']
        asset = System.delegate.get_asset(path=path)
        if not System.delegate.asset_exists(asset):
            raise StateError("asset %s does not exists in System"
                                 % asset.to_client())

    @staticmethod
    def action(args):
        path = args["path"]
        asset = System.delegate.get_asset(path=path)
        return asset

#+end_src



** =AddAssetsToLab=
#+NAME: class_add_assets_to_lab
#+begin_src python
class AddAssetsToLab():
    arg_types = {"assets": are_assets, "lab": is_lab, 
                     "session": is_session}
    arity_and_type_checks_needed = True

    @staticmethod
    def auth_check(args):
        session = args['session']
        if not System.is_session_valid(session):
            current_app.logger.error("auth error raised, session = %s" % 
                                        session.to_client())
            raise NotAuthorizedError("Not Authorized to perform this action")

    @staticmethod
    def state_check(args):
        lab = args["lab"]
        if not System.delegate.lab_exists(lab):
            current_app.logger.error("lab %s does not exist"
                                     " in System" % lab)
            raise StateError("lab %s does not exist in System"
                                 % lab.to_client())

    @staticmethod
    def action(args):
        lab = args["lab"]
        assets = args["assets"]
        try:
            lab = System.delegate.add_assets_to_lab(lab, assets) 
            return lab
        except Exception as err:
            current_app.logger.error("Exception = %s" % str(err))
            raise err

#+end_src




** Operations Table
   Each operation has a corresponding implementation defined as a class.

 #+NAME: ops_table
 #+BEGIN_SRC python                                                                          
ops_table = {'add_lab' : AddLab,
             'update_lab': UpdateLab,
             'delete_lab': DeleteLab,
             'get_lab': GetLab,
             'get_labs_by_institute': GetLabsByInstitute,
             'get_labs_by_discipline' : GetLabsByDiscipline,
             'get_labs_by_lab_name': GetLabsByLabName, 
             'get_discipline': GetDiscipline,
             'add_experiment' : AddExperiment,
             'update_experiment' : UpdateExperiment,
             'delete_experiment' : DeleteExperiment,
             'add_institute' : AddInstitute,
             'update_institute': UpdateInstitute,
             'delete_institute': DeleteInstitute,
             'get_institute' : GetInstitute,
             'get_institute_by_institute_name' : GetInstituteByInstituteName,
             'get_discipline_by_discipline_name' : GetDisciplineByDisciplineName,
             'add_section' : AddSection,
             'update_section' : UpdateSection,
             'delete_section' : DeleteSection,
             'add_name' : AddName,
             'add_email' : AddEmail,
             'add_developer' : AddDeveloper,
             'update_developer': UpdateDeveloper,
             'delete_name': DeleteName,
             'delete_email': DeleteEmail,
             'delete_developer': DeleteDeveloper,
             'add_sections_to_experiment': AddSectionsToExperiment,
             'get_experiment' : GetExperiment,
             'add_discipline' : AddDiscipline,
             'update_discipline' : UpdateDiscipline,
             'delete_discipline' : DeleteDiscipline,
             'get_name': GetName,
             'get_email': GetEmail,
             'get_developer': GetDeveloper,
             'add_hostinginfo' : AddHostingInfo,
             'get_hostinginfo': GetHostingInfo,
             'update_hostinginfo': UpdateHostingInfo,
             'delete_hostinginfo': DeleteHostingInfo,
             'add_integrationstatus' : AddIntegrationStatus,
             'get_integrationstatus': GetIntegrationStatus,
             'delete_integrationstatus': DeleteIntegrationStatus,
             'add_asset':AddAsset,
             'delete_asset': DeleteAsset,
             'get_asset': GetAsset,
             'update_asset': UpdateAsset,
             'add_assets_to_lab': AddAssetsToLab
             }

 #+END_SRC   

    
* Infra                                                         :boilerplate:

** sources
*** Imports 
#+name: imports_for_sources
#+BEGIN_SRC python
# -*- coding: utf-8 -*-

from runtime.exceptions.custom_exceptions import *
from runtime.objects.entities import is_str, is_lab, are_labs,\
     is_date, is_session, is_section, is_int, is_experiment,\
     are_experiments, are_sections, is_name, is_email, is_developer,\
     is_institute, are_institutes, is_discipline, are_disciplines,\
     is_url, is_hostinginfo, is_integrationstatus, is_asset, are_assets

from runtime.utils.type_utils import is_str_or_none
from runtime.config.system_config import KEY
import datetime
from flask import current_app

#+end_src


** tests
*** Imports 
#+name: imports_for_tests
#+BEGIN_SRC python
# -*- coding: utf-8 -*-

# -*- coding: utf-8 -*-
import unittest
from flask_testing import TestCase
from runtime.rest.app import create_app
from runtime.system.system import *
from runtime.system.persistence_delegate import *

config = {
         'SQLALCHEMY_DATABASE_URI': ''
         }

#+end_src

*** Running tests
#+NAME: run_test_cases
#+BEGIN_SRC python
if __name__ == '__main__':
    unittest.main()

#+END_SRC


* Tangling                                                      :boilerplate:

** sources
#+BEGIN_SRC python :tangle system.py :eval no :noweb yes
<<imports_for_sources>>
<<class_system>>
<<arity_type_checks>>
<<do_function>>
<<class_add_lab>>
<<class_delete_lab>>
<<class_delete_discipline>>
<<class_delete_section>>
<<class_update_section>>
<<class_delete_experiment>>
<<class_update_lab>>
<<class_update_discipline>>
<<class_add_experiment>>
<<class_add_discipline>>
<<class_update_experiment>>
<<class_add_institute>>
<<class_update_institute>>
<<class_delete_institute>>
<<class_update_section>>
<<class_add_name>>
<<class_add_email>>
<<class_add_developer>>
<<class_update_developer>>
<<class_delete_name>>
<<class_delete_email>>
<<class_delete_developer>>
<<class_add_sections_to_experiment>>
<<class_add_section>>
<<class_get_lab>>
<<class_get_name>>
<<class_get_email>>
<<class_get_developer>>
<<class_get_experiment>>
<<class_get_institute>>
<<class_get_discipline>>
<<class_get_institute_by_institute_name>>
<<class_get_discipline_by_discipline_name>>
<<class_add_hostinginfo>>
<<class_get_hostinginfo>>
<<class_update_hostinginfo>>
<<class_delete_hostinginfo>>
<<class_add_integrationstatus>>
<<class_get_integrationstatus>>
<<class_delete_integrationstatus>>
<<class_get_labs_by_institute>>
<<class_get_labs_by_lab_name>>
<<class_get_labs_by_discipline>>
<<class_add_asset>>
<<class_get_asset>>
<<class_update_asset>>
<<class_delete_asset>>
<<class_add_assets_to_lab>>
<<ops_table>>

#+end_src


** tests
#+BEGIN_SRC python :tangle test_system.py :eval no :noweb yes
<<imports_for_tests>>
<<test_constructor>>
<<test_arity_and_types>>
<<run_test_cases>>
#+end_src
